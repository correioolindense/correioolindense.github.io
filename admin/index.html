<!-- admin/index.html -->
<!DOCTYPE html>
<html>

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Admin</title>
  <!-- Include the identity widget -->
  <script src="https://identity.netlify.com/v1/netlify-identity-widget.js" type="text/javascript"></script>
</head>

<body>
  <!-- Include the script that builds the page and powers Decap CMS -->
  <script src="https://unpkg.com/decap-cms@^3.0.0/dist/decap-cms.js"></script>
  <!-- SHIM: grava o token no localStorage quando o provider envia o postMessage -->
  <script>
    (function () {
      window.addEventListener('message', function (e) {
        try {
          if (typeof e.data !== 'string') return;
          var prefix = 'authorization:github:success:';
          if (!e.data.startsWith(prefix)) return;

          var payload = JSON.parse(e.data.slice(prefix.length)); // { token, provider }

          // >>> formato que o Decap espera <<<
          var userObj = {
            token: payload.token,
            backendName: 'github',
            user: { login: 'github' }       // <= precisa estar aninhado aqui
          };

          localStorage.setItem('netlify-cms-user', JSON.stringify(userObj));

          // recarrega para o Decap ler o token e montar o painel
          location.replace(location.href.split('#')[0] + '#/');
          location.reload();
        } catch (err) {
          console.error('Auth shim error:', err);
        }
      });
    })();
  </script>
</body>

</html>